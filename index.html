<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Meme Social - Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css">
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gradient-to-tr from-blue-50 to-indigo-100 min-h-screen flex flex-col items-center">

  <nav class="bg-white/90 backdrop-blur shadow-md px-6 py-2 w-full flex justify-between items-center sticky top-0 z-50">
    <span class="text-2xl font-extrabold text-indigo-600 tracking-tight flex items-center gap-2">
      <i class="fas fa-crown text-yellow-400 animate-bounce"></i> Meme Social
    </span>
  </nav>

  <main class="flex flex-col items-center mt-16" id="authSection">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full animate-fadeIn">
      <h2 class="text-3xl font-extrabold text-indigo-600 text-center mb-6 tracking-tight" id="authTitle">Login</h2>
      <form id="authForm" class="flex flex-col gap-3">
        <div id="usernameField" class="hidden">
          <input type="text" id="username" class="input border-2 border-indigo-100 focus:border-indigo-400 rounded-lg px-4 py-2 w-full transition-custom" placeholder="Username" autocomplete="username" />
        </div>
        <input type="email" id="email" class="input border-2 border-indigo-100 focus:border-indigo-400 rounded-lg px-4 py-2 w-full transition-custom" placeholder="Email" required autocomplete="email" />
        <input type="password" id="password" class="input border-2 border-indigo-100 focus:border-indigo-400 rounded-lg px-4 py-2 w-full transition-custom" placeholder="Password" required autocomplete="current-password" />
        <button type="submit" class="bg-gradient-to-r from-indigo-500 to-blue-500 text-white rounded-lg py-2 font-bold hover:scale-105 transition-transform shadow-md">Login</button>
        <button id="googleSignInBtn" type="button"
          class="bg-white border border-gray-300 rounded-lg py-2 px-4 w-full flex items-center justify-center gap-2 font-semibold text-gray-700 hover:bg-gray-100 transition mb-2">
          <img src="https://unpkg.com/simple-icons@v11/icons/google.svg" alt="Google" class="w-5 h-5"> Sign in with Google
        </button>
      </form>
      <div class="text-center mt-4">
        <button id="toggleAuthBtn" class="text-indigo-700 hover:underline text-sm font-semibold transition-custom">Don't have an account? Register</button>
      </div>
      <div class="text-red-500 text-center mt-2 font-medium" id="authError"></div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.0"></script>
  <script>
    // ==== CONFIG: REPLACE WITH YOUR IDs ====
    const APPWRITE_ENDPOINT = "https://fra.cloud.appwrite.io/v1";
    const APPWRITE_PROJECT = "683de53b0032c338fa4b";
    const APPWRITE_DB = "683de6560007db2161b7";
    const APPWRITE_USERS = "Meme";
    // ==== END CONFIG ====

    const client = new window.appwrite.Client();
    client.setEndpoint(APPWRITE_ENDPOINT).setProject(APPWRITE_PROJECT);
    const account = new window.appwrite.Account(client);
    const databases = new window.appwrite.Databases(client);

    // DOM
    const authForm = document.getElementById('authForm');
    const toggleAuthBtn = document.getElementById('toggleAuthBtn');
    const authTitle = document.getElementById('authTitle');
    const authError = document.getElementById('authError');
    const usernameField = document.getElementById('usernameField');

    let isRegister = false;

    function showAuth() {
      authError.textContent = "";
      if (isRegister) {
        authTitle.textContent = "Register";
        authForm.querySelector('button[type="submit"]').textContent = "Register";
        usernameField.classList.remove('hidden');
        toggleAuthBtn.textContent = "Already have an account? Login";
      } else {
        authTitle.textContent = "Login";
        authForm.querySelector('button[type="submit"]').textContent = "Login";
        usernameField.classList.add('hidden');
        toggleAuthBtn.textContent = "Don't have an account? Register";
      }
    }
    toggleAuthBtn.onclick = () => {
      isRegister = !isRegister;
      showAuth();
    };

    // Redirect to home.html if already logged in
    window.addEventListener("DOMContentLoaded", async () => {
      try {
        await account.get();
        window.location.href = "home.html";
      } catch {
        showAuth();
      }
    });

    // Register/Login Handler
    authForm.onsubmit = async (e) => {
      e.preventDefault();
      authError.textContent = "";
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();
      const name = document.getElementById('username') ? document.getElementById('username').value.trim() : '';
      try {
        if (isRegister) {
          if (!name) {
            authError.textContent = "Please enter a username.";
            return;
          }
          await account.create('unique()', email, password, name);
          await account.createEmailSession(email, password);
          // Create profile doc if not exists
          const me = await account.get();
          let docs = await databases.listDocuments(APPWRITE_DB, APPWRITE_USERS, [`email=${me.email}`]);
          if (!docs.documents.length) {
            await databases.createDocument(APPWRITE_DB, APPWRITE_USERS, me.$id, {
              username: me.name || name || email.split('@')[0],
              email: me.email,
              bio: "",
              avatar: null,
              followers: [],
              following: [],
              createdAt: new Date().toISOString()
            });
          }
        } else {
          await account.createEmailSession(email, password);
        }
        window.location.href = "home.html";
      } catch (err) {
        authError.textContent = err?.message || "Authentication failed";
      }
    };

    // Google Sign-In Handler
    document.getElementById('googleSignInBtn').onclick = async () => {
      try {
        account.createOAuth2Session(
          'google',
          window.location.origin + window.location.pathname.replace("index.html", "home.html"),
          window.location.origin + window.location.pathname
        );
      } catch (err) {
        authError.textContent = err?.message || "Google sign-in failed";
      }
    };
  </script>
</body>
</html>
